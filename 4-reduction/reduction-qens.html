
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>QENS data reduction &#8212; ESS Data Management and Scientific Computing Summer School</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '4-reduction/reduction-qens';</script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SANS data reduction" href="reduction-sans.html" />
    <link rel="prev" title="Powder diffraction data reduction" href="reduction-powder-diffraction.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">ESS Data Management and Scientific Computing Summer School</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://jupyterlab.readthedocs.io/en/stable/user/interface.html">Introduction to JupyterLab</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../1-python/python_basics.html">Python basics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../1-python/python_basics/basic_language_principles.html">Basic language principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/python_basics/sequence-data-types.html">Sequence data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/python_basics/control_structures.html">Control Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/python_basics/working-with-functions.html">Working with functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/python_basics/intermediate_topics.html">Intermediate topics</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../1-python/using_external_libraries.html">Using external libraries</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../1-python/using_external_libraries/numpy.html">Arrays with Numpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/using_external_libraries/matplotlib.html">Plotting with Matplotlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/using_external_libraries/ipywidgets.html">Interactive widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/using_external_libraries/pandas.html">Data analysis with Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-python/using_external_libraries/unit_testing.html">Unit testing</a></li>

</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Proposals, DMPs and FAIR</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://ess-dmsc-dram.github.io/winter-school/_static/proposals.pdf">The ESS Viewpoint</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">McStas</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../3-mcstas/Simulation.html">Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3-mcstas/mcstas-powder-diffraction.html">Powder diffraction exercise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3-mcstas/mcstas-qens.html">QENS exercise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3-mcstas/mcstas-sans.html">SANS exercise</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reduction with scipp</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="scipp-introduction.html">Introduction to Scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="coord-transforms.html">Coordinate transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="reduction-powder-diffraction.html">Powder diffraction data reduction</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">QENS data reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="reduction-sans.html">SANS data reduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis with EasyScience</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/intro.html">Model-dependent analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/prob_data.html">Thinking about data probabilistically</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/easy_intro.html">The <code class="docutils literal notranslate"><span class="pre">EasyScience</span></code> framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/fitting.html">Fitting data with <code class="docutils literal notranslate"><span class="pre">easyscience</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/bayes.html">Uniform priors in <code class="docutils literal notranslate"><span class="pre">easyscience</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/analysis-powder-diffraction.html">Fitting Powder Diffraction data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/analysis-qens.html">Fitting QENS data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/analysis-sans.html">Fitting SANS data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/mcmc.html">Markov chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/nested_sampling.html">Bayesian Model Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/powder_ns.html">Bayesian analysis of powder diffraction data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/qens_ns.html">Bayesian analysis of QENS data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5-analysis/sans_ns.html">Bayesian analysis of SANS data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Scicat</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/1-dataset.html">Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/2-data_curation.html">Data Curation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/3-fair_data.html">FAIR Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/4-data_metadata.html">Data and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/5-data_catalog.html">Data Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/6-scicat.html">SciCat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/7-python_libraries.html">Python Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/8-example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6-scicat/9-exercise.html">Data Curation Exercise</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">DMSC School Lecture Materials</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ess-dmsc-dram/winter-school" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ess-dmsc-dram/winter-school/issues/new?title=Issue%20on%20page%20%2F4-reduction/reduction-qens.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/4-reduction/reduction-qens.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>QENS data reduction</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-the-elastic-sample-data">Process the elastic sample data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-raw-data">Load raw data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-raw-data">Visualize the raw data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-mask-bad-region">Exercise 1: mask bad region</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transform-to-energy-transfer">Transform to energy transfer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-compute-energy-transfer">Exercise 2: Compute energy transfer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-1-finish-the-graph">Exercise 2.1: Finish the graph</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-2-compute-energy-transfer-with-the-masked-data">Exercise 2.2: Compute energy transfer with the masked data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-3-compute-energy-transfer-for-unmasked-data">Exercise 2.3: Compute energy transfer for unmasked data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-compute-energy-transfer-for-all-samples">Exercise 3: Compute energy transfer for all samples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-result-to-disk">Save result to disk</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise">Bonus exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sciline-workflow">Sciline workflow</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-set-the-workflow-parameters">Exercise 4: Set the workflow parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-make-a-y-delta-e-map">Exercise 5: Make a <span class="math notranslate nohighlight">\((y, \Delta E)\)</span> map</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="qens-data-reduction">
<h1>QENS data reduction<a class="headerlink" href="#qens-data-reduction" title="Link to this heading">#</a></h1>
<p>This notebook will guide you through the data reduction for the QENS experiment that you simulated with McStas yesterday.</p>
<p>The following is a basic outline of what this notebook will cover:</p>
<ul class="simple">
<li><p>Loading the NeXus files that contain the data</p></li>
<li><p>Inspect/visualize the data contents</p></li>
<li><p>How to convert the raw <code class="docutils literal notranslate"><span class="pre">time-of-flight</span></code> coordinate to something more useful (<span class="math notranslate nohighlight">\(\Delta E\)</span>)</p></li>
<li><p>Write the results to file</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plopp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scippneutron</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">scn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">qens_utils</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">utils</span>
</pre></div>
</div>
</div>
</div>
<section id="process-the-elastic-sample-data">
<h2>Process the elastic sample data<a class="headerlink" href="#process-the-elastic-sample-data" title="Link to this heading">#</a></h2>
<section id="load-raw-data">
<h3>Load raw data<a class="headerlink" href="#load-raw-data" title="Link to this heading">#</a></h3>
<p>Begin by loading and investigating the data obtained from the elastic sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">folder</span> <span class="o">=</span> <span class="s2">&quot;../3-mcstas/QENS_elastic_many_neutrons&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_qens</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The first way to inspect the data is to view the HTML representation of the loaded object.</p>
<p>Try to explore what is inside the data, and familiarize yourself with the different sections (<code class="docutils literal notranslate"><span class="pre">Dimensions</span></code>, <code class="docutils literal notranslate"><span class="pre">Coordinates</span></code>, <code class="docutils literal notranslate"><span class="pre">Data</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><!-- Original source from -->
<!-- https://github.com/jsignell/xarray/blob/1d960933ab252e0f79f7e050e6c9261d55568057/xarray/static/html/icons-svg-inline.html -->
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<title>Show/Hide data repr</title>
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<title>Show/Hide attributes</title>
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg><style id="scipp-style-sheet">.sc-root{--sc-background-color0:var(--jp-layout-color0,#fff);--sc-background-color1:var(--jp-layout-color1,#fcfcfc);--sc-background-color2:var(--jp-layout-color2,#efefef);--sc-inverse-background-color0:var(--jp-inverse-layout-color4,#111);--sc-font-color0:var(--jp-content-font-color0,#000);--sc-font-color1:var(--jp-content-font-color1,#555);--sc-font-color2:var(--jp-content-font-color2,#888);--sc-font-color3:var(--jp-content-font-color3,#ccc);}body.vscode-dark .sc-root{--sc-font-color0:rgba(255,255,255,1);--sc-font-color1:rgba(255,255,255,0.70);--sc-font-color2:rgba(255,255,255,0.54);--sc-font-color3:rgba(255,255,255,0.38);--sc-border-color:#1F1F1F;--sc-disabled-color:#515151;--sc-background-color0:#111111;--sc-background-color1:#111111;--sc-background-color2:#313131;}.sc-wrap{font-size:14px;min-width:300px;max-width:800px;}.sc-var-attrs .sc-wrap{padding-left:3em;}.sc-header{padding-top:6px;padding-bottom:6px;margin-bottom:4px;border-bottom:solid 1px #ddd;}.sc-header > div,.sc-header > ul{display:inline;margin-top:0;margin-bottom:0;}.sc-obj-type,.sc-array-name{margin-left:2px;margin-right:10px;}.sc-obj-type{color:var(--sc-font-color1);}.sc-underlying-size{color:var(--sc-font-color2);}.sc-sections,.reveal .sc-sections{padding-left:0 !important;display:grid;grid-template-columns:150px auto auto auto 1fr 20px 20px;}.sc-section-item{display:contents;}.sc-section-item input{display:none;}.sc-section-item input:enabled + label{cursor:pointer;color:var(--sc-font-color1);}.sc-section-item input:enabled + label:hover{color:var(--sc-font-color0);}.sc-section-summary{grid-column:1;font-weight:500;}.sc-section-summary > span{display:inline-block;padding-left:0.5em;}.sc-section-summary-in:disabled + label{color:var(--sc-font-color1);}.sc-section-summary-in + label:before{display:inline-block;content:'►';font-size:11px;width:15px;text-align:center;}.sc-section-summary-in:disabled + label:before{color:var(--sc-font-color3);}.sc-section-summary-in:checked + label:before{content:'▼';}.sc-section-summary-in:checked + label > span{display:none;}.sc-section-summary,.sc-section-inline-details{padding-top:4px;padding-bottom:4px;}.sc-section-inline-details{grid-column:2 / 6;}.sc-section-details{display:none;grid-column:1 / -1;margin-bottom:5px;}.sc-section-summary-in:checked ~ .sc-section-details{display:contents;}.sc-array-wrap{grid-column:1 / -1;display:grid;grid-template-columns:20px auto;}.sc-array-wrap > label{grid-column:1;vertical-align:top;}.sc-preview{color:var(--sc-font-color2);}.sc-array-preview,.sc-array-data{padding:0 5px !important;grid-column:2;}.sc-array-data,.sc-array-in:checked ~ .sc-array-preview{display:none;}.sc-array-in:checked ~ .sc-array-data,.sc-array-preview{display:inline-block;}.sc-dim-list{display:inline-block !important;list-style:none;padding:0 !important;margin:0;}.sc-dim-list li{display:inline-block;padding:0;margin:0!important;}.sc-dim-list:before{content:'(';}.sc-dim-list:after{content:')';}.sc-dim-list li:not(:last-child):after{content:',';padding-right:5px;}.sc-dim-list li span,.sc-standalone-var-name > span span,.sc-var-name > span span{padding:0 !important;}.sc-aligned{font-weight:bold;}.sc-var-list,.sc-var-item,.reveal .sc-var-list,.reveal .sc-var-item{display:contents;}.sc-var-item > div,.sc-var-item label,.sc-var-item > .sc-var-name span{background-color:var(--sc-background-color1);margin-bottom:0;}.sc-var-item > .sc-var-name:hover span{padding-right:5px;}.sc-var-list > li:nth-child(odd) > div,.sc-var-list > li:nth-child(odd) > label,.sc-var-list > li:nth-child(odd) > .sc-var-name span{background-color:var(--sc-background-color2);}.sc-var-name{grid-column:1;}.sc-var-dims{grid-column:2;}.sc-var-dtype{grid-column:3;text-align:right;color:var(--sc-font-color2);}.sc-var-unit{grid-column:4;text-align:left;color:var(--sc-font-color1);max-width:50pt;text-overflow:ellipsis;}.sc-value-preview{grid-column:5;}.sc-var-preview-variances{text-align:right;}.sc-sections .sc-section-item .sc-section-summary,.sc-sections .sc-section-item .sc-section-inline-details,.sc-section-item .sc-var-list .sc-var-item > div,.sc-section-item .sc-var-list .sc-var-item > label,.sc-section-details .sc-var-list .sc-var-item > div,.sc-section-details .sc-var-list .sc-var-item > label{margin-top:0;margin-bottom:0;}.sc-var-name,.sc-var-dims,.sc-var-dtype,.sc-var-unit,.sc-preview,.sc-attrs dt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:10px;}.sc-var-name:hover,.sc-var-dims:hover,.sc-var-dtype:hover,.sc-var-unit:hover,.sc-attrs dt:hover{overflow:visible;width:auto;z-index:1;}.sc-var-attrs{display:block;}.sc-var-data,.reveal .sc-var-data{display:none;}.sc-var-attrs,.sc-var-data{background-color:var(--sc-background-color0) !important;padding-bottom:5px !important;}.sc-var-attrs-in:checked ~ .sc-var-attrs{display:none;}.sc-var-data-in:checked ~ .sc-var-data{display:block;}.sc-var-data > table{float:right;}.sc-var-name span,.sc-var-data{padding-left:25px !important;}.sc-var-attrs,.sc-var-data{grid-column:1 / -1;}dl.sc-attrs{padding:0;margin:0;display:grid;grid-template-columns:125px auto;}.sc-attrs dt,dd{padding:0;margin:0;float:left;padding-right:10px;width:auto;}.sc-attrs dt{font-weight:normal;grid-column:1;}.sc-attrs dt:hover span{display:inline-block;padding-right:10px;}.sc-attrs dd{grid-column:2;white-space:pre-wrap;word-break:break-all;}.sc-icon-database,.sc-icon-file-text2{display:inline-block;vertical-align:middle;width:1em;height:1.5em !important;stroke-width:0;stroke:currentColor;fill:currentColor;}label.sc-hide-icon svg{opacity:0;}.sc-standalone-var-name{grid-column:1/3;}.sc-standalone-var-name span{padding-left:25px;padding-right:10px;}.sc-title{font-weight:bold;font-size:1.5em;}.sc-subtitle{font-weight:normal;font-style:italic;text-align:left;font-size:1.2em;padding:1px;}.sc-label{fill:var(--sc-font-color0,#444444);text-anchor:middle;}.sc-name{fill:var(--sc-font-color0,#111111);}.sc-inset-line{stroke:var(--sc-font-color1);stroke-width:0.05;stroke-dasharray:0.2,0.2;}.sc-log-wrap{height:25ex;resize:vertical;overflow-y:scroll;display:flex;flex-direction:column-reverse;border:1px solid;border-color:var(--jp-border-color2);background-color:var(--sc-background-color1);}div.sc-log{line-height:2.5ex;}table.sc-log{table-layout:auto;border-collapse:collapse;}tr.sc-log:nth-child(even){background-color:var(--sc-background-color0);}tr.sc-log > td{vertical-align:top;padding-bottom:0.5ex;}.sc-log-time-stamp{min-width:22ch;font-family:var(--jp-code-font-family);color:var(--sc-font-color2);}.sc-log-level{min-width:10ch;}tr.sc-log-debug td.sc-log-level{color:var(--jp-accent-color1);}tr.sc-log-info td.sc-log-level{color:var(--jp-info-color1);}tr.sc-log-warning td.sc-log-level{color:var(--jp-warn-color1);}tr.sc-log-error td.sc-log-level{font-weight:bold;color:var(--jp-error-color2);}tr.sc-log-critical td.sc-log-level{font-weight:bold;color:var(--sc-background-color0);background-color:var(--jp-error-color1);}.sc-log-message{white-space:pre-wrap;width:100%;}.sc-log-html-payload{white-space:normal;}.sc-log-name{padding-right:0.5em;text-align:right;white-space:pre-wrap;color:var(--sc-font-color3);}</style><div class='sc-wrap sc-root'><div class='sc-header'><div class='sc-obj-type'>scipp.DataArray (86.03 MB)</div></div><ul class='sc-sections'><li class='sc-section-item'><input id='section-6e037455-7e66-4f52-b784-e59087af405d' class='sc-section-summary-in' type='checkbox' disabled ><label for='section-6e037455-7e66-4f52-b784-e59087af405d' class='sc-section-summary' >Dimensions:</label><div class='sc-section-inline-details'><ul class='sc-dim-list'><li><span>event</span>: 1127524</li></ul></div><div class='sc-section-details'></div></li><li class='sc-section-item'><input id='section-ece38f50-2038-45af-968c-3e42df51d91e' class='sc-section-summary-in' type='checkbox'  checked><label for='section-ece38f50-2038-45af-968c-3e42df51d91e' class='sc-section-summary'  title='Expand/collapse section'>Coordinates: <span>(11)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>analyzer_angle</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>rad</div><div class='sc-value-preview sc-preview'><span><div>0.04157061594422062</div></span></div><input id='attrs-1a944ab7-de07-4a0c-b287-74b3047861dc' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-1a944ab7-de07-4a0c-b287-74b3047861dc' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f0c2f75c-2c53-4773-be73-2a3327204010' class='sc-var-data-in' type='checkbox'><label for='data-f0c2f75c-2c53-4773-be73-2a3327204010' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(0.04157062)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>analyzer_dspacing</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>Å</div><div class='sc-value-preview sc-preview'><span><div>3.135</div></span></div><input id='attrs-6f974a2d-f427-4c54-9867-da6458045d4e' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-6f974a2d-f427-4c54-9867-da6458045d4e' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-1c33e0cc-12d1-4d3d-b80c-0153857bf38e' class='sc-var-data-in' type='checkbox'><label for='data-1c33e0cc-12d1-4d3d-b80c-0153857bf38e' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(3.135)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>analyzer_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[1.5        0.         2.59807621]</div></span></div><input id='attrs-19b7ae8e-125a-4dff-b451-7ad3fc0e02aa' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-19b7ae8e-125a-4dff-b451-7ad3fc0e02aa' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c14f1820-1f57-42a6-94ff-6467332a0ef0' class='sc-var-data-in' type='checkbox'><label for='data-c14f1820-1f57-42a6-94ff-6467332a0ef0' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([1.5       , 0.        , 2.59807621])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>id</span></div><div class='sc-var-dims'>(event)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'></div><div class='sc-value-preview sc-preview'><span><div>-1.078e+09, -1.078e+09, ..., 1.293e+09, 1.293e+09</div></span></div><input id='attrs-ec041b1a-4137-40f1-af3b-d1ceca00449f' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-ec041b1a-4137-40f1-af3b-d1ceca00449f' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-26c61357-8d67-4a3e-9397-46ba9ec10f4f' class='sc-var-data-in' type='checkbox'><label for='data-26c61357-8d67-4a3e-9397-46ba9ec10f4f' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([-1.07837658e+09, -1.07837619e+09, -1.07837617e+09, ...,
        1.29266314e+09,  1.29266255e+09,  1.29266254e+09],
      shape=(1127524,))</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>n</span></div><div class='sc-var-dims'>(event)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'></div><div class='sc-value-preview sc-preview'><span><div>-4.641e+18, -4.638e+18, ..., -4.638e+18, -4.651e+18</div></span></div><input id='attrs-365a4c4a-55f1-44e3-b071-c32e6282bb44' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-365a4c4a-55f1-44e3-b071-c32e6282bb44' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-0fc5cb0a-6216-486b-892e-1c6d6f387b87' class='sc-var-data-in' type='checkbox'><label for='data-0fc5cb0a-6216-486b-892e-1c6d6f387b87' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([-4.64136508e+18, -4.63824674e+18,  4.55374904e+18, ...,
        4.57782871e+18, -4.63788457e+18, -4.65143093e+18],
      shape=(1127524,))</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>position</span></div><div class='sc-var-dims'>(event)</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[0.         0.22458694 0.        ], [0.         0.27645328 0.        ], ..., [0.         0.21147578 0.        ], [0.         0.21015867 0.        ]</div></span></div><input id='attrs-07e29f89-87ab-4ebb-86a5-86a5d225d4e6' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-07e29f89-87ab-4ebb-86a5-86a5d225d4e6' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-30dec6d4-ce2d-44b6-a288-3e19274b54ab' class='sc-var-data-in' type='checkbox'><label for='data-30dec6d4-ce2d-44b6-a288-3e19274b54ab' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([[0.        , 0.22458694, 0.        ],
       [0.        , 0.27645328, 0.        ],
       [0.        , 0.27899908, 0.        ],
       ...,
       [0.        , 0.28881908, 0.        ],
       [0.        , 0.21147578, 0.        ],
       [0.        , 0.21015867, 0.        ]], shape=(1127524, 3))</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>sample_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[0. 0. 0.]</div></span></div><input id='attrs-0c1ef4f2-df36-472b-bc6f-dcca301814fc' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-0c1ef4f2-df36-472b-bc6f-dcca301814fc' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-3ecb1fd9-5ef4-4d76-a350-6f7cacb2cd04' class='sc-var-data-in' type='checkbox'><label for='data-3ecb1fd9-5ef4-4d76-a350-6f7cacb2cd04' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([0., 0., 0.])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>source_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[   0.    0. -150.]</div></span></div><input id='attrs-bd2ba0d9-c50c-4f30-b682-54b531f20200' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-bd2ba0d9-c50c-4f30-b682-54b531f20200' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-34ad2742-4ab4-4247-a7f9-528cdef8f474' class='sc-var-data-in' type='checkbox'><label for='data-34ad2742-4ab4-4247-a7f9-528cdef8f474' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([   0.,    0., -150.])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>tof</span></div><div class='sc-var-dims'>(event)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>ms</div><div class='sc-value-preview sc-preview'><span><div>246.960, 246.898, ..., 246.999, 247.005</div></span></div><input id='attrs-ace9d41b-0c91-4db8-814e-80ffe91ab5ef' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-ace9d41b-0c91-4db8-814e-80ffe91ab5ef' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d0b5e978-7cfb-46c1-85e5-1db5fc107afb' class='sc-var-data-in' type='checkbox'><label for='data-d0b5e978-7cfb-46c1-85e5-1db5fc107afb' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([246.95969626, 246.89765645, 246.90459462, ..., 247.11583627,
       246.99917752, 247.00500948], shape=(1127524,))</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>x</span></div><div class='sc-var-dims'>(event)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>0.0, 0.0, ..., 0.0, 0.0</div></span></div><input id='attrs-ed031542-1019-49d6-91be-1ede814096f3' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-ed031542-1019-49d6-91be-1ede814096f3' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d3e513a6-b7bd-4f94-9822-92384d60a0bc' class='sc-var-data-in' type='checkbox'><label for='data-d3e513a6-b7bd-4f94-9822-92384d60a0bc' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([0., 0., 0., ..., 0., 0., 0.], shape=(1127524,))</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>y</span></div><div class='sc-var-dims'>(event)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>0.225, 0.276, ..., 0.211, 0.210</div></span></div><input id='attrs-63c9607c-7056-4b25-8446-fb8fb8b7b4ca' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-63c9607c-7056-4b25-8446-fb8fb8b7b4ca' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-609c11b6-1576-450c-81bb-90891e78986a' class='sc-var-data-in' type='checkbox'><label for='data-609c11b6-1576-450c-81bb-90891e78986a' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([0.22458694, 0.27645328, 0.27899908, ..., 0.28881908, 0.21147578,
       0.21015867], shape=(1127524,))</pre></span></li></ul></div></li><li class='sc-section-item'><input id='section-e3efce02-3c57-4ade-ba8d-591e3083036d' class='sc-section-summary-in' type='checkbox'  checked><label for='section-e3efce02-3c57-4ade-ba8d-591e3083036d' class='sc-section-summary'  title='Expand/collapse section'>Data: <span>(1)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span></span></div><div class='sc-var-dims'>(event)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>counts</div><div class='sc-value-preview sc-preview'><span><div>1.647e-05, 0.008, ..., 1.741e-15, 3.207e-19</div></span><span><div>σ = 1.647e-05, 0.008, ..., 1.741e-15, 3.207e-19</div></span></div><input id='attrs-04a99601-1444-4ea7-b9c9-b3f38940119e' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-04a99601-1444-4ea7-b9c9-b3f38940119e' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ae5dc61e-3700-42a8-9b5f-3cc616aa476f' class='sc-var-data-in' type='checkbox'><label for='data-ae5dc61e-3700-42a8-9b5f-3cc616aa476f' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([1.64707330e-05, 8.36332599e-03, 3.44812028e-06, ...,
       3.22543413e-38, 1.74055049e-15, 3.20711694e-19], shape=(1127524,))<br><br>Variances (σ²):<br>array([2.71285045e-10, 6.99452216e-05, 1.18895334e-11, ...,
       1.04034254e-75, 3.02951602e-30, 1.02855990e-37], shape=(1127524,))</pre></li></ul></div></li></ul></div></div></div></div>
</div>
</section>
<section id="visualize-the-raw-data">
<h3>Visualize the raw data<a class="headerlink" href="#visualize-the-raw-data" title="Link to this heading">#</a></h3>
<p>Here is a histogram of the raw data in <code class="docutils literal notranslate"><span class="pre">tof</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tof</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5d29c1af80ba550a6e25a9e556bc48781dd26bd317ceef106e88d37b8ca12953.svg" src="../_images/5d29c1af80ba550a6e25a9e556bc48781dd26bd317ceef106e88d37b8ca12953.svg" />
</div>
</div>
<p>It is more enlightening to look at a 2D histogram in <code class="docutils literal notranslate"><span class="pre">tof</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> as this shows a defect of the detector for a certain y-range:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tof</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1da6fb410218ff99dc8f3db86f67bf8d7d79eadf0d0008a0ce8837a7dbacc193.svg" src="../_images/1da6fb410218ff99dc8f3db86f67bf8d7d79eadf0d0008a0ce8837a7dbacc193.svg" />
</div>
</div>
</section>
<section id="exercise-1-mask-bad-region">
<h3>Exercise 1: mask bad region<a class="headerlink" href="#exercise-1-mask-bad-region" title="Link to this heading">#</a></h3>
<p>We need to handle the events that are affected by the detector defect.
The simplest way of doing so it to mask the affected region in y.
We will do so by binning in y and applying a y-dependent mask to the data array.</p>
<p><strong>Steps</strong>:</p>
<ol class="arabic simple">
<li><p>Define bin-edges in the y-dimension that cover the entire range of the data.
There should be three bins which cover the y-range below the broken region, the broken region, and the the range above the broken region, respectively.
So you should end up with a length-4 array of bin-edges.</p></li>
<li><p>Define another array for the mask which should have the values <code class="docutils literal notranslate"><span class="pre">[False,</span> <span class="pre">True,</span> <span class="pre">False]</span></code>.
So it masks the middle bin but not the others.</p></li>
<li><p>Apply the mask by binning the events using the edges you defined and inserting the mask into the binned array’s masks.</p></li>
</ol>
<p><strong>Hints</strong>:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">sc.array</span></code> to create arrays for the bin-edges and the mask.</p></li>
<li><p>Bin the data using <code class="docutils literal notranslate"><span class="pre">binned_for_mask</span> <span class="pre">=</span> <span class="pre">events.bin(...)</span></code>,</p></li>
<li><p>Apply the mask by inserting it into <code class="docutils literal notranslate"><span class="pre">binned_for_mask.masks</span></code> which behaves like a <code class="docutils literal notranslate"><span class="pre">dict</span></code>.</p></li>
</ul>
<p><strong>Solution:</strong></p>
<div class="cell tag_hide-cell tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
<span class="n">mask_regions</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
    <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">,</span> <span class="mf">0.27</span><span class="p">,</span> <span class="mf">0.29</span><span class="p">],</span>
    <span class="n">unit</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">binned_for_mask</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">mask_regions</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
<span class="n">binned_for_mask</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s2">&quot;bad_timing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
<span class="n">binned_for_mask</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><!-- Original source from -->
<!-- https://github.com/jsignell/xarray/blob/1d960933ab252e0f79f7e050e6c9261d55568057/xarray/static/html/icons-svg-inline.html -->
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<title>Show/Hide data repr</title>
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<title>Show/Hide attributes</title>
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg><style id="scipp-style-sheet">.sc-root{--sc-background-color0:var(--jp-layout-color0,#fff);--sc-background-color1:var(--jp-layout-color1,#fcfcfc);--sc-background-color2:var(--jp-layout-color2,#efefef);--sc-inverse-background-color0:var(--jp-inverse-layout-color4,#111);--sc-font-color0:var(--jp-content-font-color0,#000);--sc-font-color1:var(--jp-content-font-color1,#555);--sc-font-color2:var(--jp-content-font-color2,#888);--sc-font-color3:var(--jp-content-font-color3,#ccc);}body.vscode-dark .sc-root{--sc-font-color0:rgba(255,255,255,1);--sc-font-color1:rgba(255,255,255,0.70);--sc-font-color2:rgba(255,255,255,0.54);--sc-font-color3:rgba(255,255,255,0.38);--sc-border-color:#1F1F1F;--sc-disabled-color:#515151;--sc-background-color0:#111111;--sc-background-color1:#111111;--sc-background-color2:#313131;}.sc-wrap{font-size:14px;min-width:300px;max-width:800px;}.sc-var-attrs .sc-wrap{padding-left:3em;}.sc-header{padding-top:6px;padding-bottom:6px;margin-bottom:4px;border-bottom:solid 1px #ddd;}.sc-header > div,.sc-header > ul{display:inline;margin-top:0;margin-bottom:0;}.sc-obj-type,.sc-array-name{margin-left:2px;margin-right:10px;}.sc-obj-type{color:var(--sc-font-color1);}.sc-underlying-size{color:var(--sc-font-color2);}.sc-sections,.reveal .sc-sections{padding-left:0 !important;display:grid;grid-template-columns:150px auto auto auto 1fr 20px 20px;}.sc-section-item{display:contents;}.sc-section-item input{display:none;}.sc-section-item input:enabled + label{cursor:pointer;color:var(--sc-font-color1);}.sc-section-item input:enabled + label:hover{color:var(--sc-font-color0);}.sc-section-summary{grid-column:1;font-weight:500;}.sc-section-summary > span{display:inline-block;padding-left:0.5em;}.sc-section-summary-in:disabled + label{color:var(--sc-font-color1);}.sc-section-summary-in + label:before{display:inline-block;content:'►';font-size:11px;width:15px;text-align:center;}.sc-section-summary-in:disabled + label:before{color:var(--sc-font-color3);}.sc-section-summary-in:checked + label:before{content:'▼';}.sc-section-summary-in:checked + label > span{display:none;}.sc-section-summary,.sc-section-inline-details{padding-top:4px;padding-bottom:4px;}.sc-section-inline-details{grid-column:2 / 6;}.sc-section-details{display:none;grid-column:1 / -1;margin-bottom:5px;}.sc-section-summary-in:checked ~ .sc-section-details{display:contents;}.sc-array-wrap{grid-column:1 / -1;display:grid;grid-template-columns:20px auto;}.sc-array-wrap > label{grid-column:1;vertical-align:top;}.sc-preview{color:var(--sc-font-color2);}.sc-array-preview,.sc-array-data{padding:0 5px !important;grid-column:2;}.sc-array-data,.sc-array-in:checked ~ .sc-array-preview{display:none;}.sc-array-in:checked ~ .sc-array-data,.sc-array-preview{display:inline-block;}.sc-dim-list{display:inline-block !important;list-style:none;padding:0 !important;margin:0;}.sc-dim-list li{display:inline-block;padding:0;margin:0!important;}.sc-dim-list:before{content:'(';}.sc-dim-list:after{content:')';}.sc-dim-list li:not(:last-child):after{content:',';padding-right:5px;}.sc-dim-list li span,.sc-standalone-var-name > span span,.sc-var-name > span span{padding:0 !important;}.sc-aligned{font-weight:bold;}.sc-var-list,.sc-var-item,.reveal .sc-var-list,.reveal .sc-var-item{display:contents;}.sc-var-item > div,.sc-var-item label,.sc-var-item > .sc-var-name span{background-color:var(--sc-background-color1);margin-bottom:0;}.sc-var-item > .sc-var-name:hover span{padding-right:5px;}.sc-var-list > li:nth-child(odd) > div,.sc-var-list > li:nth-child(odd) > label,.sc-var-list > li:nth-child(odd) > .sc-var-name span{background-color:var(--sc-background-color2);}.sc-var-name{grid-column:1;}.sc-var-dims{grid-column:2;}.sc-var-dtype{grid-column:3;text-align:right;color:var(--sc-font-color2);}.sc-var-unit{grid-column:4;text-align:left;color:var(--sc-font-color1);max-width:50pt;text-overflow:ellipsis;}.sc-value-preview{grid-column:5;}.sc-var-preview-variances{text-align:right;}.sc-sections .sc-section-item .sc-section-summary,.sc-sections .sc-section-item .sc-section-inline-details,.sc-section-item .sc-var-list .sc-var-item > div,.sc-section-item .sc-var-list .sc-var-item > label,.sc-section-details .sc-var-list .sc-var-item > div,.sc-section-details .sc-var-list .sc-var-item > label{margin-top:0;margin-bottom:0;}.sc-var-name,.sc-var-dims,.sc-var-dtype,.sc-var-unit,.sc-preview,.sc-attrs dt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:10px;}.sc-var-name:hover,.sc-var-dims:hover,.sc-var-dtype:hover,.sc-var-unit:hover,.sc-attrs dt:hover{overflow:visible;width:auto;z-index:1;}.sc-var-attrs{display:block;}.sc-var-data,.reveal .sc-var-data{display:none;}.sc-var-attrs,.sc-var-data{background-color:var(--sc-background-color0) !important;padding-bottom:5px !important;}.sc-var-attrs-in:checked ~ .sc-var-attrs{display:none;}.sc-var-data-in:checked ~ .sc-var-data{display:block;}.sc-var-data > table{float:right;}.sc-var-name span,.sc-var-data{padding-left:25px !important;}.sc-var-attrs,.sc-var-data{grid-column:1 / -1;}dl.sc-attrs{padding:0;margin:0;display:grid;grid-template-columns:125px auto;}.sc-attrs dt,dd{padding:0;margin:0;float:left;padding-right:10px;width:auto;}.sc-attrs dt{font-weight:normal;grid-column:1;}.sc-attrs dt:hover span{display:inline-block;padding-right:10px;}.sc-attrs dd{grid-column:2;white-space:pre-wrap;word-break:break-all;}.sc-icon-database,.sc-icon-file-text2{display:inline-block;vertical-align:middle;width:1em;height:1.5em !important;stroke-width:0;stroke:currentColor;fill:currentColor;}label.sc-hide-icon svg{opacity:0;}.sc-standalone-var-name{grid-column:1/3;}.sc-standalone-var-name span{padding-left:25px;padding-right:10px;}.sc-title{font-weight:bold;font-size:1.5em;}.sc-subtitle{font-weight:normal;font-style:italic;text-align:left;font-size:1.2em;padding:1px;}.sc-label{fill:var(--sc-font-color0,#444444);text-anchor:middle;}.sc-name{fill:var(--sc-font-color0,#111111);}.sc-inset-line{stroke:var(--sc-font-color1);stroke-width:0.05;stroke-dasharray:0.2,0.2;}.sc-log-wrap{height:25ex;resize:vertical;overflow-y:scroll;display:flex;flex-direction:column-reverse;border:1px solid;border-color:var(--jp-border-color2);background-color:var(--sc-background-color1);}div.sc-log{line-height:2.5ex;}table.sc-log{table-layout:auto;border-collapse:collapse;}tr.sc-log:nth-child(even){background-color:var(--sc-background-color0);}tr.sc-log > td{vertical-align:top;padding-bottom:0.5ex;}.sc-log-time-stamp{min-width:22ch;font-family:var(--jp-code-font-family);color:var(--sc-font-color2);}.sc-log-level{min-width:10ch;}tr.sc-log-debug td.sc-log-level{color:var(--jp-accent-color1);}tr.sc-log-info td.sc-log-level{color:var(--jp-info-color1);}tr.sc-log-warning td.sc-log-level{color:var(--jp-warn-color1);}tr.sc-log-error td.sc-log-level{font-weight:bold;color:var(--jp-error-color2);}tr.sc-log-critical td.sc-log-level{font-weight:bold;color:var(--sc-background-color0);background-color:var(--jp-error-color1);}.sc-log-message{white-space:pre-wrap;width:100%;}.sc-log-html-payload{white-space:normal;}.sc-log-name{padding-right:0.5em;text-align:right;white-space:pre-wrap;color:var(--sc-font-color3);}</style><div class='sc-wrap sc-root'><div class='sc-header'><div class='sc-obj-type'>scipp.DataArray (86.03 MB)</div></div><ul class='sc-sections'><li class='sc-section-item'><input id='section-2ef06db0-5623-4c89-9cc8-beea87f24447' class='sc-section-summary-in' type='checkbox' disabled ><label for='section-2ef06db0-5623-4c89-9cc8-beea87f24447' class='sc-section-summary' >Dimensions:</label><div class='sc-section-inline-details'><ul class='sc-dim-list'><li><span class='sc-has-index'>y</span>: 3</li></ul></div><div class='sc-section-details'></div></li><li class='sc-section-item'><input id='section-8d12a565-fe58-462d-a050-a8e420fce11e' class='sc-section-summary-in' type='checkbox'  checked><label for='section-8d12a565-fe58-462d-a050-a8e420fce11e' class='sc-section-summary'  title='Expand/collapse section'>Coordinates: <span>(6)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>analyzer_angle</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>rad</div><div class='sc-value-preview sc-preview'><span><div>0.04157061594422062</div></span></div><input id='attrs-a78f8c36-9823-4553-ac7e-6c4676a0ec57' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-a78f8c36-9823-4553-ac7e-6c4676a0ec57' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-9f10ff5e-4921-470c-aa09-acac5b2620e2' class='sc-var-data-in' type='checkbox'><label for='data-9f10ff5e-4921-470c-aa09-acac5b2620e2' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(0.04157062)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>analyzer_dspacing</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>Å</div><div class='sc-value-preview sc-preview'><span><div>3.135</div></span></div><input id='attrs-7412c84c-693d-48b6-89ee-639c9b905a68' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-7412c84c-693d-48b6-89ee-639c9b905a68' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-2074ce18-cc00-414c-8549-0febece3adee' class='sc-var-data-in' type='checkbox'><label for='data-2074ce18-cc00-414c-8549-0febece3adee' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(3.135)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>analyzer_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[1.5        0.         2.59807621]</div></span></div><input id='attrs-af6fdbd1-c01e-4806-9dec-3bbe9ce1a01c' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-af6fdbd1-c01e-4806-9dec-3bbe9ce1a01c' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-e9271010-cb22-40ad-9cbc-73a033959e6c' class='sc-var-data-in' type='checkbox'><label for='data-e9271010-cb22-40ad-9cbc-73a033959e6c' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([1.5       , 0.        , 2.59807621])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>sample_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[0. 0. 0.]</div></span></div><input id='attrs-538f82b9-6e42-476c-b861-5087fddb2d0d' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-538f82b9-6e42-476c-b861-5087fddb2d0d' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-112d1c9f-4619-4860-af4b-fab28951d196' class='sc-var-data-in' type='checkbox'><label for='data-112d1c9f-4619-4860-af4b-fab28951d196' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([0., 0., 0.])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>source_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[   0.    0. -150.]</div></span></div><input id='attrs-edec4d95-a2d5-4cda-aebb-e02547c7a5f4' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-edec4d95-a2d5-4cda-aebb-e02547c7a5f4' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-935839bd-2501-471e-a69c-80a02df7f596' class='sc-var-data-in' type='checkbox'><label for='data-935839bd-2501-471e-a69c-80a02df7f596' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([   0.,    0., -150.])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>y</span></div><div class='sc-var-dims'>(y [bin-edge])</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>0.21, 0.26, 0.27, 0.29</div></span></div><input id='attrs-43c2c257-1b7b-46f6-983b-5cbc37e9b080' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-43c2c257-1b7b-46f6-983b-5cbc37e9b080' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c220d7e4-ab46-4362-9a3a-250bd3161f0a' class='sc-var-data-in' type='checkbox'><label for='data-c220d7e4-ab46-4362-9a3a-250bd3161f0a' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([0.21, 0.26, 0.27, 0.29])</pre></span></li></ul></div></li><li class='sc-section-item'><input id='section-89992776-9d91-45d2-8bc7-6ebd617186e2' class='sc-section-summary-in' type='checkbox'  checked><label for='section-89992776-9d91-45d2-8bc7-6ebd617186e2' class='sc-section-summary'  title='Expand/collapse section'>Data: <span>(1)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span></span></div><div class='sc-var-dims'>(y)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>counts</div><div class='sc-value-preview sc-preview'><span><div>binned data [len=730673, len=174695, len=222156]</div></span></div><input id='attrs-f4d14fbc-00c0-4d05-9124-4f268cc1723c' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-f4d14fbc-00c0-4d05-9124-4f268cc1723c' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f8b559ad-56e1-4c25-a90c-81718a57cea6' class='sc-var-data-in' type='checkbox'><label for='data-f8b559ad-56e1-4c25-a90c-81718a57cea6' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>dim=&#x27;event&#x27;,
content=DataArray(
          dims=(event: 1127524),
          data=float64[counts],
          coords={&#x27;x&#x27;:float64[m], &#x27;y&#x27;:float64[m], &#x27;n&#x27;:float64, &#x27;id&#x27;:float64,
                  &#x27;position&#x27;:vector3[m], &#x27;tof&#x27;:float64[ms]})</pre></li></ul></div></li><li class='sc-section-item'><input id='section-01ac574d-50de-4915-b897-74b90d9bad4b' class='sc-section-summary-in' type='checkbox'  checked><label for='section-01ac574d-50de-4915-b897-74b90d9bad4b' class='sc-section-summary'  title='Expand/collapse section'>Masks: <span>(1)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span>bad_timing</span></div><div class='sc-var-dims'>(y)</div><div class='sc-var-dtype'>bool</div><div class='sc-var-unit'></div><div class='sc-value-preview sc-preview'><span><div>False, True, False</div></span></div><input id='attrs-cd6acbae-d2af-4059-be42-a8e28b1e56c8' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-cd6acbae-d2af-4059-be42-a8e28b1e56c8' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-dbf014d3-8b96-47ed-b6f6-fb853ebbadc6' class='sc-var-data-in' type='checkbox'><label for='data-dbf014d3-8b96-47ed-b6f6-fb853ebbadc6' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([False,  True, False])</pre></span></li></ul></div></li></ul></div></div></div></div>
</details>
</div>
<p>We plot the data array with the mask below.
The black band in the middle bin indicates the mask:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">binned_for_mask</span><span class="o">.</span><span class="n">hist</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4a3733aae473d85bfec4500cb3b0556939d333b986247abd9ce51bf3623f1333.svg" src="../_images/4a3733aae473d85bfec4500cb3b0556939d333b986247abd9ce51bf3623f1333.svg" />
</div>
</div>
<p>When making the same 2D histogram as before, the masked events will be dropped and the result is a histogram with a gap:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">binned_for_mask</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tof</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/763fb659df1e09ee5eb505f63567b554890d633a871284945a2dc537f48c355d.svg" src="../_images/763fb659df1e09ee5eb505f63567b554890d633a871284945a2dc537f48c355d.svg" />
</div>
</div>
</section>
<section id="transform-to-energy-transfer">
<h3>Transform to energy transfer<a class="headerlink" href="#transform-to-energy-transfer" title="Link to this heading">#</a></h3>
<p>The next step is to compute the measured energy transfer in the sample from time-of-flight and the other coordinates of our data.
We use <a class="reference external" href="https://scipp.github.io/generated/functions/scipp.transform_coords.html">scipp.transform_coords</a> for this purpose.</p>
<p>Scippneutron provides some pre-defined functions for coordinate transformations, see the <a class="reference external" href="https://scipp.github.io/scippneutron/user-guide/coordinate-transformations.html">documentation</a> for a list.
In particular, it provides <a class="reference external" href="https://scipp.github.io/scippneutron/generated/modules/scippneutron.conversion.tof.energy_transfer_indirect_from_tof.html">scippneutron.conversion.tof.energy_transfer_indirect_from_tof</a> which computes the energy transfer for an indirect-geometry spectrometer:</p>
<div class="math notranslate nohighlight">
\[\Delta E = \frac{m_n L_1^2}{2 {(t-t_0)}^2} - \mathsf{final\_energy}\,, \qquad t_0 = \sqrt{\frac{L_2^2 m_n}{2 \mathsf{final\_energy}}}\,,\]</div>
<p>where <span class="math notranslate nohighlight">\(m_n\)</span> is the neutron mass, <span class="math notranslate nohighlight">\(L_1\)</span> is the primary flight path length (from source to sample), and <span class="math notranslate nohighlight">\(L_2\)</span> is the secondary flight path length (from sample to detector).
The intermediate variable <span class="math notranslate nohighlight">\(t_0\)</span> is the the time of flight for the secondary path such that <span class="math notranslate nohighlight">\((t - t_0)\)</span> is the arrival time at the sample.</p>
<p>While Scippneutron provides most of what we need, we have to define some custom components for our specific instrument.
We require functions to compute</p>
<ul class="simple">
<li><p><strong>L2</strong>, the path length of the scattered neutron. The default function in Scippneutron assumes a straight path but here, we need to take the reflection from the analyzer crystal into account: <span class="math notranslate nohighlight">\(L_2 = |\overline{\mathsf{sample},\mathsf{analyzer}}| + |\overline{\mathsf{analyser},\mathsf{detector}}|\)</span></p></li>
<li><p><strong>final_wavelength</strong>, the neutron wavelength that the analyzer selects for. We compute it from the known <span class="math notranslate nohighlight">\(d\)</span>-spacing of the analyzer <span class="math notranslate nohighlight">\(d_a\)</span> and the scattering angle off the analyzer <span class="math notranslate nohighlight">\(\theta_a\)</span>: <span class="math notranslate nohighlight">\(\mathsf{final\_wavelength} = 2 d_a \sin{\theta_a}\)</span></p></li>
<li><p><strong>final_energy</strong>, the energy of the neutrons that hit the detector (more below): <span class="math notranslate nohighlight">\(\mathsf{final\_energy} = \displaystyle\frac{m_n}{2} v_f^2\)</span></p></li>
</ul>
<p>The first two are implemented below.
They use the positions and analyzer parameters in the input data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">backscattered_l2</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">sample_position</span><span class="p">,</span> <span class="n">analyzer_position</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the length of the secondary flight path for backscattering off an analyzer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">analyzer_position</span><span class="p">)</span> <span class="o">+</span> <span class="n">sc</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
        <span class="n">analyzer_position</span> <span class="o">-</span> <span class="n">sample_position</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">wavelength_from_analyzer</span><span class="p">(</span><span class="n">analyzer_dspacing</span><span class="p">,</span> <span class="n">analyzer_angle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the neutron wavelength after scattering from the analyzer&#39;s d-spacing.</span>

<span class="sd">    Assuming Bragg scattering in the analyzer, the wavelength is</span>
<span class="sd">        wavelength = 2 * d * sin(theta)</span>

<span class="sd">    Where</span>
<span class="sd">        d is the analyzer&#39;s d-spacing,</span>
<span class="sd">        theta is the scattering angle or equivalently, the tilt of the analyzer</span>
<span class="sd">              w.r.t. to the sample-analyzer axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 2*theta is the angle between transmitted and scattered beam.</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="mi">2</span>
        <span class="o">*</span> <span class="n">analyzer_dspacing</span>
        <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;rad&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">analyzer_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;rad&quot;</span><span class="p">))</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can start assembling the graph to compute the energy transfer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scippneutron.conversion.graph.beamline</span><span class="w"> </span><span class="kn">import</span> <span class="n">beamline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scippneutron.conversion.tof</span><span class="w"> </span><span class="kn">import</span> <span class="n">energy_transfer_indirect_from_tof</span>

<span class="n">graph</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="n">beamline</span><span class="p">(</span><span class="n">scatter</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s2">&quot;energy_transfer&quot;</span><span class="p">:</span> <span class="n">energy_transfer_indirect_from_tof</span><span class="p">,</span>
    <span class="c1"># Replace L2 with our own implementation.</span>
    <span class="s2">&quot;L2&quot;</span><span class="p">:</span> <span class="n">backscattered_l2</span><span class="p">,</span>
    <span class="c1"># Insert a new function for the wavelength.</span>
    <span class="s2">&quot;final_wavelength&quot;</span><span class="p">:</span> <span class="n">wavelength_from_analyzer</span><span class="p">,</span>
<span class="p">}</span>
<span class="c1"># Optional: remove unused functions in order to clean up the image below.</span>
<span class="k">del</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;two_theta&quot;</span><span class="p">]</span>
<span class="k">del</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;scattered_beam&quot;</span><span class="p">]</span>
<span class="k">del</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;Ltotal&quot;</span><span class="p">]</span>
<span class="n">sc</span><span class="o">.</span><span class="n">show_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">simplified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2d8ca7bb685a69ca0e6b94561811fe650b1493d95f7192a0a20f26e0eb910315.svg" src="../_images/2d8ca7bb685a69ca0e6b94561811fe650b1493d95f7192a0a20f26e0eb910315.svg" />
</div>
</div>
</section>
<section id="exercise-2-compute-energy-transfer">
<h3>Exercise 2: Compute energy transfer<a class="headerlink" href="#exercise-2-compute-energy-transfer" title="Link to this heading">#</a></h3>
<p>We can see that <code class="docutils literal notranslate"><span class="pre">final_energy</span></code> is not yet linked to <code class="docutils literal notranslate"><span class="pre">final_wavelength</span></code> in the graph.
Your task is to implement a function <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">final_energy(final_wavelength)</span></code> to fill in the gap.</p>
<p>The energy is given by</p>
<div class="math notranslate nohighlight">
\[\mathsf{final\_energy} = \frac{m_n}{2} v_f^2, \qquad v_f = \frac{2\pi\hbar}{m_n \mathsf{final\_wavelength}},\]</div>
<p>where <span class="math notranslate nohighlight">\(v_f\)</span> is the speed of the scattered neutron and <span class="math notranslate nohighlight">\(m_n\)</span> is the neutron mass.</p>
<section id="exercise-2-1-finish-the-graph">
<h4>Exercise 2.1: Finish the graph<a class="headerlink" href="#exercise-2-1-finish-the-graph" title="Link to this heading">#</a></h4>
<p><strong>Steps</strong>:</p>
<ul class="simple">
<li><p>Define a new function that computes the final energy given the equations above.</p>
<ul>
<li><p>Tip: Ensure that the result has unit <code class="docutils literal notranslate"><span class="pre">meV</span></code>.</p></li>
<li><p>Tip: Use <a class="reference external" href="https://scipp.github.io/generated/modules/scipp.constants.html">sc.constants</a> to get values for <span class="math notranslate nohighlight">\(\hbar\)</span> (or <span class="math notranslate nohighlight">\(h\)</span>) and <span class="math notranslate nohighlight">\(m_n\)</span>.</p></li>
</ul>
</li>
<li><p>Insert the new function into the graph.</p></li>
</ul>
<p><strong>Solution:</strong></p>
<div class="cell tag_hide-cell tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">final_energy</span><span class="p">(</span><span class="n">final_wavelength</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the neutron energy after scattering.</span>

<span class="sd">    Uses</span>
<span class="sd">        final_energy = mn / 2 * final_speed**2</span>
<span class="sd">        final_speed = 2 * pi * hbar / mn / final_wavelength</span>

<span class="sd">    Where</span>
<span class="sd">        mn is the neutron mass,</span>
<span class="sd">        final_wavelength is the wavelength after scattering,</span>
<span class="sd">        final_speed is the speed after scattering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">to_unit</span><span class="p">(</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">sc</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">neutron_mass</span> <span class="o">/</span> <span class="p">(</span><span class="n">final_wavelength</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
        <span class="s2">&quot;meV&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">graph</span><span class="p">[</span><span class="s2">&quot;final_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_energy</span>
<span class="n">sc</span><span class="o">.</span><span class="n">show_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">simplified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9f6ec40b921e4b80a138322bcd0149d321546a5d01f6134a7bdbcf24049eaf62.svg" src="../_images/9f6ec40b921e4b80a138322bcd0149d321546a5d01f6134a7bdbcf24049eaf62.svg" />
</div>
</details>
</div>
</section>
<section id="exercise-2-2-compute-energy-transfer-with-the-masked-data">
<h4>Exercise 2.2: Compute energy transfer with the masked data<a class="headerlink" href="#exercise-2-2-compute-energy-transfer-with-the-masked-data" title="Link to this heading">#</a></h4>
<p>Use <code class="docutils literal notranslate"><span class="pre">binned_for_mask.transform_coords</span></code> (or what ever name you used for the masked array) to compute <code class="docutils literal notranslate"><span class="pre">&quot;energy_transfer&quot;</span></code>.</p>
<div class="cell tag_hide-cell tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">in_energy_transfer</span> <span class="o">=</span> <span class="n">binned_for_mask</span><span class="o">.</span><span class="n">transform_coords</span><span class="p">(</span><span class="s2">&quot;energy_transfer&quot;</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span>
<span class="n">in_energy_transfer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><!-- Original source from -->
<!-- https://github.com/jsignell/xarray/blob/1d960933ab252e0f79f7e050e6c9261d55568057/xarray/static/html/icons-svg-inline.html -->
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<title>Show/Hide data repr</title>
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<title>Show/Hide attributes</title>
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg><style id="scipp-style-sheet">.sc-root{--sc-background-color0:var(--jp-layout-color0,#fff);--sc-background-color1:var(--jp-layout-color1,#fcfcfc);--sc-background-color2:var(--jp-layout-color2,#efefef);--sc-inverse-background-color0:var(--jp-inverse-layout-color4,#111);--sc-font-color0:var(--jp-content-font-color0,#000);--sc-font-color1:var(--jp-content-font-color1,#555);--sc-font-color2:var(--jp-content-font-color2,#888);--sc-font-color3:var(--jp-content-font-color3,#ccc);}body.vscode-dark .sc-root{--sc-font-color0:rgba(255,255,255,1);--sc-font-color1:rgba(255,255,255,0.70);--sc-font-color2:rgba(255,255,255,0.54);--sc-font-color3:rgba(255,255,255,0.38);--sc-border-color:#1F1F1F;--sc-disabled-color:#515151;--sc-background-color0:#111111;--sc-background-color1:#111111;--sc-background-color2:#313131;}.sc-wrap{font-size:14px;min-width:300px;max-width:800px;}.sc-var-attrs .sc-wrap{padding-left:3em;}.sc-header{padding-top:6px;padding-bottom:6px;margin-bottom:4px;border-bottom:solid 1px #ddd;}.sc-header > div,.sc-header > ul{display:inline;margin-top:0;margin-bottom:0;}.sc-obj-type,.sc-array-name{margin-left:2px;margin-right:10px;}.sc-obj-type{color:var(--sc-font-color1);}.sc-underlying-size{color:var(--sc-font-color2);}.sc-sections,.reveal .sc-sections{padding-left:0 !important;display:grid;grid-template-columns:150px auto auto auto 1fr 20px 20px;}.sc-section-item{display:contents;}.sc-section-item input{display:none;}.sc-section-item input:enabled + label{cursor:pointer;color:var(--sc-font-color1);}.sc-section-item input:enabled + label:hover{color:var(--sc-font-color0);}.sc-section-summary{grid-column:1;font-weight:500;}.sc-section-summary > span{display:inline-block;padding-left:0.5em;}.sc-section-summary-in:disabled + label{color:var(--sc-font-color1);}.sc-section-summary-in + label:before{display:inline-block;content:'►';font-size:11px;width:15px;text-align:center;}.sc-section-summary-in:disabled + label:before{color:var(--sc-font-color3);}.sc-section-summary-in:checked + label:before{content:'▼';}.sc-section-summary-in:checked + label > span{display:none;}.sc-section-summary,.sc-section-inline-details{padding-top:4px;padding-bottom:4px;}.sc-section-inline-details{grid-column:2 / 6;}.sc-section-details{display:none;grid-column:1 / -1;margin-bottom:5px;}.sc-section-summary-in:checked ~ .sc-section-details{display:contents;}.sc-array-wrap{grid-column:1 / -1;display:grid;grid-template-columns:20px auto;}.sc-array-wrap > label{grid-column:1;vertical-align:top;}.sc-preview{color:var(--sc-font-color2);}.sc-array-preview,.sc-array-data{padding:0 5px !important;grid-column:2;}.sc-array-data,.sc-array-in:checked ~ .sc-array-preview{display:none;}.sc-array-in:checked ~ .sc-array-data,.sc-array-preview{display:inline-block;}.sc-dim-list{display:inline-block !important;list-style:none;padding:0 !important;margin:0;}.sc-dim-list li{display:inline-block;padding:0;margin:0!important;}.sc-dim-list:before{content:'(';}.sc-dim-list:after{content:')';}.sc-dim-list li:not(:last-child):after{content:',';padding-right:5px;}.sc-dim-list li span,.sc-standalone-var-name > span span,.sc-var-name > span span{padding:0 !important;}.sc-aligned{font-weight:bold;}.sc-var-list,.sc-var-item,.reveal .sc-var-list,.reveal .sc-var-item{display:contents;}.sc-var-item > div,.sc-var-item label,.sc-var-item > .sc-var-name span{background-color:var(--sc-background-color1);margin-bottom:0;}.sc-var-item > .sc-var-name:hover span{padding-right:5px;}.sc-var-list > li:nth-child(odd) > div,.sc-var-list > li:nth-child(odd) > label,.sc-var-list > li:nth-child(odd) > .sc-var-name span{background-color:var(--sc-background-color2);}.sc-var-name{grid-column:1;}.sc-var-dims{grid-column:2;}.sc-var-dtype{grid-column:3;text-align:right;color:var(--sc-font-color2);}.sc-var-unit{grid-column:4;text-align:left;color:var(--sc-font-color1);max-width:50pt;text-overflow:ellipsis;}.sc-value-preview{grid-column:5;}.sc-var-preview-variances{text-align:right;}.sc-sections .sc-section-item .sc-section-summary,.sc-sections .sc-section-item .sc-section-inline-details,.sc-section-item .sc-var-list .sc-var-item > div,.sc-section-item .sc-var-list .sc-var-item > label,.sc-section-details .sc-var-list .sc-var-item > div,.sc-section-details .sc-var-list .sc-var-item > label{margin-top:0;margin-bottom:0;}.sc-var-name,.sc-var-dims,.sc-var-dtype,.sc-var-unit,.sc-preview,.sc-attrs dt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:10px;}.sc-var-name:hover,.sc-var-dims:hover,.sc-var-dtype:hover,.sc-var-unit:hover,.sc-attrs dt:hover{overflow:visible;width:auto;z-index:1;}.sc-var-attrs{display:block;}.sc-var-data,.reveal .sc-var-data{display:none;}.sc-var-attrs,.sc-var-data{background-color:var(--sc-background-color0) !important;padding-bottom:5px !important;}.sc-var-attrs-in:checked ~ .sc-var-attrs{display:none;}.sc-var-data-in:checked ~ .sc-var-data{display:block;}.sc-var-data > table{float:right;}.sc-var-name span,.sc-var-data{padding-left:25px !important;}.sc-var-attrs,.sc-var-data{grid-column:1 / -1;}dl.sc-attrs{padding:0;margin:0;display:grid;grid-template-columns:125px auto;}.sc-attrs dt,dd{padding:0;margin:0;float:left;padding-right:10px;width:auto;}.sc-attrs dt{font-weight:normal;grid-column:1;}.sc-attrs dt:hover span{display:inline-block;padding-right:10px;}.sc-attrs dd{grid-column:2;white-space:pre-wrap;word-break:break-all;}.sc-icon-database,.sc-icon-file-text2{display:inline-block;vertical-align:middle;width:1em;height:1.5em !important;stroke-width:0;stroke:currentColor;fill:currentColor;}label.sc-hide-icon svg{opacity:0;}.sc-standalone-var-name{grid-column:1/3;}.sc-standalone-var-name span{padding-left:25px;padding-right:10px;}.sc-title{font-weight:bold;font-size:1.5em;}.sc-subtitle{font-weight:normal;font-style:italic;text-align:left;font-size:1.2em;padding:1px;}.sc-label{fill:var(--sc-font-color0,#444444);text-anchor:middle;}.sc-name{fill:var(--sc-font-color0,#111111);}.sc-inset-line{stroke:var(--sc-font-color1);stroke-width:0.05;stroke-dasharray:0.2,0.2;}.sc-log-wrap{height:25ex;resize:vertical;overflow-y:scroll;display:flex;flex-direction:column-reverse;border:1px solid;border-color:var(--jp-border-color2);background-color:var(--sc-background-color1);}div.sc-log{line-height:2.5ex;}table.sc-log{table-layout:auto;border-collapse:collapse;}tr.sc-log:nth-child(even){background-color:var(--sc-background-color0);}tr.sc-log > td{vertical-align:top;padding-bottom:0.5ex;}.sc-log-time-stamp{min-width:22ch;font-family:var(--jp-code-font-family);color:var(--sc-font-color2);}.sc-log-level{min-width:10ch;}tr.sc-log-debug td.sc-log-level{color:var(--jp-accent-color1);}tr.sc-log-info td.sc-log-level{color:var(--jp-info-color1);}tr.sc-log-warning td.sc-log-level{color:var(--jp-warn-color1);}tr.sc-log-error td.sc-log-level{font-weight:bold;color:var(--jp-error-color2);}tr.sc-log-critical td.sc-log-level{font-weight:bold;color:var(--sc-background-color0);background-color:var(--jp-error-color1);}.sc-log-message{white-space:pre-wrap;width:100%;}.sc-log-html-payload{white-space:normal;}.sc-log-name{padding-right:0.5em;text-align:right;white-space:pre-wrap;color:var(--sc-font-color3);}</style><div class='sc-wrap sc-root'><div class='sc-header'><div class='sc-obj-type'>scipp.DataArray (103.23 MB)</div></div><ul class='sc-sections'><li class='sc-section-item'><input id='section-986f964e-80c9-41a4-ac94-175fc811da22' class='sc-section-summary-in' type='checkbox' disabled ><label for='section-986f964e-80c9-41a4-ac94-175fc811da22' class='sc-section-summary' >Dimensions:</label><div class='sc-section-inline-details'><ul class='sc-dim-list'><li><span class='sc-has-index'>y</span>: 3</li></ul></div><div class='sc-section-details'></div></li><li class='sc-section-item'><input id='section-c7f7a77e-9d82-4464-8694-1da4b07519ff' class='sc-section-summary-in' type='checkbox'  checked><label for='section-c7f7a77e-9d82-4464-8694-1da4b07519ff' class='sc-section-summary'  title='Expand/collapse section'>Coordinates: <span>(10)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span>L1</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>150.0</div></span></div><input id='attrs-50a25abe-be79-4b83-8d92-ba383a636801' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-50a25abe-be79-4b83-8d92-ba383a636801' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5c264bf2-1a21-407e-8741-eec36296b0ed' class='sc-var-data-in' type='checkbox'><label for='data-5c264bf2-1a21-407e-8741-eec36296b0ed' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(150.)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>analyzer_angle</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>rad</div><div class='sc-value-preview sc-preview'><span><div>0.04157061594422062</div></span></div><input id='attrs-0341e2c2-8603-42f6-8e14-2f39a8739b6c' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-0341e2c2-8603-42f6-8e14-2f39a8739b6c' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-09f209f2-ed83-49ec-936d-0184e1b479e7' class='sc-var-data-in' type='checkbox'><label for='data-09f209f2-ed83-49ec-936d-0184e1b479e7' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(0.04157062)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>analyzer_dspacing</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>Å</div><div class='sc-value-preview sc-preview'><span><div>3.135</div></span></div><input id='attrs-16a68b7e-f7c4-43ac-9e81-8e03c45a971f' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-16a68b7e-f7c4-43ac-9e81-8e03c45a971f' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-eb9fd5aa-6c61-4033-9e2c-3db5d70a0c87' class='sc-var-data-in' type='checkbox'><label for='data-eb9fd5aa-6c61-4033-9e2c-3db5d70a0c87' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(3.135)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>analyzer_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[1.5        0.         2.59807621]</div></span></div><input id='attrs-5b868d42-9f0b-4d26-b9cc-c2fb2cc0b5c1' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-5b868d42-9f0b-4d26-b9cc-c2fb2cc0b5c1' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-fdc125ae-5111-4ab8-a7f5-ce02720bf2c3' class='sc-var-data-in' type='checkbox'><label for='data-fdc125ae-5111-4ab8-a7f5-ce02720bf2c3' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([1.5       , 0.        , 2.59807621])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>final_energy</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>meV</div><div class='sc-value-preview sc-preview'><span><div>2.08444913589009</div></span></div><input id='attrs-0e559244-cdf1-4ee8-834c-79cdea396432' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-0e559244-cdf1-4ee8-834c-79cdea396432' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-985be34f-1ae4-41fb-811b-169d9a9d85a7' class='sc-var-data-in' type='checkbox'><label for='data-985be34f-1ae4-41fb-811b-169d9a9d85a7' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(2.08444914)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>final_wavelength</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>Å</div><div class='sc-value-preview sc-preview'><span><div>6.264583136143423</div></span></div><input id='attrs-4880a0ad-9efa-4c8a-a1ed-b5add7fa6ef7' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-4880a0ad-9efa-4c8a-a1ed-b5add7fa6ef7' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4f2444d2-0ebb-4f6c-a32d-43cb725737a7' class='sc-var-data-in' type='checkbox'><label for='data-4f2444d2-0ebb-4f6c-a32d-43cb725737a7' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(6.26458314)</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>incident_beam</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[  0.   0. 150.]</div></span></div><input id='attrs-be0ee4c0-8eda-46bd-a6af-ff45bb53d283' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-be0ee4c0-8eda-46bd-a6af-ff45bb53d283' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f893008b-a420-4395-b59f-a31abaf16570' class='sc-var-data-in' type='checkbox'><label for='data-f893008b-a420-4395-b59f-a31abaf16570' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([  0.,   0., 150.])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>sample_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[0. 0. 0.]</div></span></div><input id='attrs-6b6cbaa3-f209-44d5-bba0-ea55df3cc05f' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-6b6cbaa3-f209-44d5-bba0-ea55df3cc05f' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d596527c-a7e6-4c98-a3c1-464e42a9d61b' class='sc-var-data-in' type='checkbox'><label for='data-d596527c-a7e6-4c98-a3c1-464e42a9d61b' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([0., 0., 0.])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span>source_position</span></div><div class='sc-var-dims'>()</div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[   0.    0. -150.]</div></span></div><input id='attrs-24797097-41c7-4bf8-ba5b-7537770f1d4e' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-24797097-41c7-4bf8-ba5b-7537770f1d4e' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ce3b97ce-7aff-49f7-a0ff-da55bfd51e17' class='sc-var-data-in' type='checkbox'><label for='data-ce3b97ce-7aff-49f7-a0ff-da55bfd51e17' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([   0.,    0., -150.])</pre></span></li><li class='sc-var-item'><div class='sc-var-name'><span class='sc-aligned'>y</span></div><div class='sc-var-dims'>(y [bin-edge])</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>0.21, 0.26, 0.27, 0.29</div></span></div><input id='attrs-39ee92be-e558-48ea-8a19-2cf7bfe232ba' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-39ee92be-e558-48ea-8a19-2cf7bfe232ba' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-6193cb48-7dc2-4faa-b19f-527b3ef34341' class='sc-var-data-in' type='checkbox'><label for='data-6193cb48-7dc2-4faa-b19f-527b3ef34341' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([0.21, 0.26, 0.27, 0.29])</pre></span></li></ul></div></li><li class='sc-section-item'><input id='section-6c150829-f3db-4931-9c88-1ddd1b79c4c5' class='sc-section-summary-in' type='checkbox'  checked><label for='section-6c150829-f3db-4931-9c88-1ddd1b79c4c5' class='sc-section-summary'  title='Expand/collapse section'>Data: <span>(1)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span></span></div><div class='sc-var-dims'>(y)</div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>counts</div><div class='sc-value-preview sc-preview'><span><div>binned data [len=730673, len=174695, len=222156]</div></span></div><input id='attrs-17176778-10ae-49bf-b8f8-95b8256f6f9d' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-17176778-10ae-49bf-b8f8-95b8256f6f9d' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-e8cac2fc-568b-47cc-9e01-e4160d5e4427' class='sc-var-data-in' type='checkbox'><label for='data-e8cac2fc-568b-47cc-9e01-e4160d5e4427' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>dim=&#x27;event&#x27;,
content=DataArray(
          dims=(event: 1127524),
          data=float64[counts],
          coords={&#x27;x&#x27;:float64[m], &#x27;y&#x27;:float64[m], &#x27;n&#x27;:float64, &#x27;id&#x27;:float64,
                  &#x27;position&#x27;:vector3[m], &#x27;tof&#x27;:float64[ms], &#x27;L2&#x27;:float64[m],
                  &#x27;energy_transfer&#x27;:float64[meV]})</pre></li></ul></div></li><li class='sc-section-item'><input id='section-87535f4b-2d01-4e27-a35b-2432da2ed37f' class='sc-section-summary-in' type='checkbox'  checked><label for='section-87535f4b-2d01-4e27-a35b-2432da2ed37f' class='sc-section-summary'  title='Expand/collapse section'>Masks: <span>(1)</span></label><div class='sc-section-inline-details'></div><div class='sc-section-details'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-var-name'><span>bad_timing</span></div><div class='sc-var-dims'>(y)</div><div class='sc-var-dtype'>bool</div><div class='sc-var-unit'></div><div class='sc-value-preview sc-preview'><span><div>False, True, False</div></span></div><input id='attrs-70bcd133-4d32-4b0a-8566-ee34c2ea5198' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-70bcd133-4d32-4b0a-8566-ee34c2ea5198' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-1db7ce19-d160-44e4-8835-497690b0145a' class='sc-var-data-in' type='checkbox'><label for='data-1db7ce19-d160-44e4-8835-497690b0145a' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([False,  True, False])</pre></span></li></ul></div></li></ul></div></div></div></div>
</details>
</div>
</section>
<section id="exercise-2-3-compute-energy-transfer-for-unmasked-data">
<h4>Exercise 2.3: Compute energy transfer for unmasked data<a class="headerlink" href="#exercise-2-3-compute-energy-transfer-for-unmasked-data" title="Link to this heading">#</a></h4>
<p>For comparison, also compute energy transfer with the original data without a mask.</p>
<p><strong>Solution:</strong></p>
<div class="cell tag_hide-cell tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">in_energy_transfer_unmasked</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">transform_coords</span><span class="p">(</span><span class="s2">&quot;energy_transfer&quot;</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Now we can plot the masked and unmasked data to compare them.
As always, we first need to histogram them.
(We use <code class="docutils literal notranslate"><span class="pre">in_energy_transfer.bins.concat()</span></code> to undo the binning from exercise 1.
Without it, we would get a 2D histogram in <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">energy_transfer</span></code>.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">masked_hist</span> <span class="o">=</span> <span class="n">in_energy_transfer</span><span class="o">.</span><span class="n">bins</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">energy_transfer</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">unmasked_hist</span> <span class="o">=</span> <span class="n">in_energy_transfer_unmasked</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">energy_transfer</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And finally, we can plot the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;unmasked&quot;</span><span class="p">:</span> <span class="n">unmasked_hist</span><span class="p">,</span>
        <span class="s2">&quot;masked&quot;</span><span class="p">:</span> <span class="n">masked_hist</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4e45d51c80053e620301c75b8c10c80b3dbf9ec527e4049b11caebb4611578e6.svg" src="../_images/4e45d51c80053e620301c75b8c10c80b3dbf9ec527e4049b11caebb4611578e6.svg" />
</div>
</div>
</section>
</section>
<section id="exercise-3-compute-energy-transfer-for-all-samples">
<h3>Exercise 3: Compute energy transfer for all samples<a class="headerlink" href="#exercise-3-compute-energy-transfer-for-all-samples" title="Link to this heading">#</a></h3>
<p>We have only looked at one of our three samples so far.
Now, we repeat the same procedure for the remaining two.</p>
<p>Your task is to load the other samples, mask the broken detector region, and compute energy_transfer.
(You don’t need to repeat the calculation for the unmasked data.</p>
<p><strong>Hints</strong>:</p>
<ul class="simple">
<li><p>Write a function that encapsulates the whole procedure.</p></li>
<li><p>You can reuse the mask bin-edges and the mask itself.</p></li>
<li><p>Store the results for all samples in a <code class="docutils literal notranslate"><span class="pre">dict</span></code>. This way, you can easily plot it using <code class="docutils literal notranslate"><span class="pre">pp.plot</span></code>.</p></li>
<li><p>Use a scalar variable with a unit, e.g. <code class="docutils literal notranslate"><span class="pre">sc.scalar(0.01,</span> <span class="pre">unit='meV')</span></code>, for the histogramming to get a constant bin width.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">folders</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;../3-mcstas/QENS_elastic_many_neutrons&quot;</span><span class="p">,</span>
    <span class="s2">&quot;../3-mcstas/QENS_known_quasi_elastic_many_neutrons&quot;</span><span class="p">,</span>
    <span class="s2">&quot;../3-mcstas/QENS_unknown_quasi_elastic_many_neutrons&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Solution:</strong></p>
<div class="cell tag_hide-cell tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">process_sample</span><span class="p">(</span><span class="n">raw_events</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">=</span><span class="mf">0.001</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;meV&quot;</span><span class="p">)):</span>
    <span class="n">binned_for_mask</span> <span class="o">=</span> <span class="n">raw_events</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">mask_regions</span><span class="p">)</span>
    <span class="n">binned_for_mask</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s2">&quot;bad_timing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="n">in_energy_transfer</span> <span class="o">=</span> <span class="n">binned_for_mask</span><span class="o">.</span><span class="n">transform_coords</span><span class="p">(</span>
        <span class="s2">&quot;energy_transfer&quot;</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span>
    <span class="p">)</span>

    <span class="n">hist</span> <span class="o">=</span> <span class="n">in_energy_transfer</span><span class="o">.</span><span class="n">bins</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">energy_transfer</span><span class="o">=</span><span class="n">bin_width</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hist</span>


<span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_qens</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="c1"># Remove the file path prefix from the folder name</span>
    <span class="n">data_name</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">results</span><span class="p">[</span><span class="n">data_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_sample</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

<span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ba1f1d605480c7ba8190d7c5202599cd07520b0c583998e5c1c8606947eda932.svg" src="../_images/ba1f1d605480c7ba8190d7c5202599cd07520b0c583998e5c1c8606947eda932.svg" />
</div>
</details>
</div>
</section>
<section id="save-result-to-disk">
<h3>Save result to disk<a class="headerlink" href="#save-result-to-disk" title="Link to this heading">#</a></h3>
<p>Finally, we need to save our results to disk so that the reduced data can be forwarded to the next step in the pipeline (data analysis).
We will use a simple text file for this.</p>
<p>This code assumes that you stored your histograms in a <code class="docutils literal notranslate"><span class="pre">dict</span></code> called <code class="docutils literal notranslate"><span class="pre">results</span></code>.
If this is not the case, you need to modify the code below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scippneutron.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_xye</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># The simple file format does not support bin-edge coordinates.</span>
    <span class="c1"># So we convert to bin-centers first.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;energy_transfer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">midpoints</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;energy_transfer&quot;</span><span class="p">])</span>

    <span class="n">save_xye</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;energy_transfer_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="bonus-exercise">
<h2>Bonus exercise<a class="headerlink" href="#bonus-exercise" title="Link to this heading">#</a></h2>
<p>Re-run the reduction using the results from the simulations with less neutrons,
and compare the results.</p>
<p><strong>Solution:</strong></p>
<div class="cell tag_hide-input tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_widths</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0001</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;meV&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.001</span> <span class="o">*</span> <span class="n">sc</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;meV&quot;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>

<span class="n">figures</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">bin_width</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bin_widths</span><span class="p">,</span> <span class="n">folders</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="n">case</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_many_neutrons&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">case</span><span class="p">]:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_qens</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">data_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="n">data_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_sample</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">)</span>

    <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">results</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">case</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;../3-mcstas/QENS_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_many_neutrons&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="n">figures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">figures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">figures</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/df4db65a6cfa1fb21a21492e93a849ee8c6c3902207eba0866acb896b52162e9.svg" src="../_images/df4db65a6cfa1fb21a21492e93a849ee8c6c3902207eba0866acb896b52162e9.svg" />
</div>
</div>
</section>
<section id="sciline-workflow">
<h2>Sciline workflow<a class="headerlink" href="#sciline-workflow" title="Link to this heading">#</a></h2>
<div class="alert alert-warning">
<p><strong>Pause here if you have not yet been introduced to Sciline!</strong></p>
</div>
<p>Below we build a re-usable Sciline workflow for reducing the QENS data.
We wrap the operations that were carried out throughout this notebook into function that have the correct type-annotations,
building a pipeline of connected steps.</p>
<p>The custom types have been created for you in the <code class="docutils literal notranslate"><span class="pre">qens_utils</span></code> module, and are imported from there.</p>
<p>Take some time to read through the code and understand the different parts.
Ask questions if anything is unclear.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sciline</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qens_utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">folder</span><span class="p">:</span> <span class="n">Foldername</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load raw data from file&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">RawData</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">load_qens</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">mask_bad_region</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">RawData</span><span class="p">,</span> <span class="n">masked_range</span><span class="p">:</span> <span class="n">MaskedRange</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MaskedData</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
    <span class="n">mask_regions</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="n">masked_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">masked_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="p">],</span>
        <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">binned_for_mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">mask_regions</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
    <span class="n">binned_for_mask</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s2">&quot;bad_timing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="k">return</span> <span class="n">MaskedData</span><span class="p">(</span><span class="n">binned_for_mask</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_energy_transfer</span><span class="p">(</span>
    <span class="n">masked</span><span class="p">:</span> <span class="n">MaskedData</span><span class="p">,</span> <span class="n">graph</span><span class="p">:</span> <span class="n">CoordTransformGraph</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyTransferData</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">EnergyTransferData</span><span class="p">(</span><span class="n">masked</span><span class="o">.</span><span class="n">transform_coords</span><span class="p">(</span><span class="s2">&quot;energy_transfer&quot;</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_histogram</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">EnergyTransferData</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">:</span> <span class="n">BinWidth</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnergyTransferHistogram</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">EnergyTransferHistogram</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">bins</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">energy_transfer</span><span class="o">=</span><span class="n">bin_width</span><span class="p">))</span>


<span class="n">wf</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">((</span><span class="n">load</span><span class="p">,</span> <span class="n">mask_bad_region</span><span class="p">,</span> <span class="n">to_energy_transfer</span><span class="p">,</span> <span class="n">to_histogram</span><span class="p">))</span>

<span class="n">wf</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/55bf1cd41bb7b3775e436026b4c8ec1db675f2ca9fbf1d0b7f0eca9fbc44347d.svg" src="../_images/55bf1cd41bb7b3775e436026b4c8ec1db675f2ca9fbf1d0b7f0eca9fbc44347d.svg" />
</div>
</div>
<section id="exercise-4-set-the-workflow-parameters">
<h3>Exercise 4: Set the workflow parameters<a class="headerlink" href="#exercise-4-set-the-workflow-parameters" title="Link to this heading">#</a></h3>
<p>In the visualization above, the red boxes indicate missing values;
parameters required by the computation that have yet to be set on the workflow.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">wf[TYPE]</span> <span class="pre">=</span> <span class="pre">VALUE</span></code> syntax, set the missing parameters on the workflow.</p>
<p>Once you have done so, use <code class="docutils literal notranslate"><span class="pre">wf.compute(EnergyTransferHistogram)</span></code> multiple times to compute the final result for each sample,
making sure to change the folder to load the data from each time.</p>
<p>Store your results in a <code class="docutils literal notranslate"><span class="pre">dict</span></code> and use <code class="docutils literal notranslate"><span class="pre">pp.plot(results)</span></code> to plot all curves on the same figure.</p>
<p><strong>Solution:</strong></p>
<div class="cell tag_hide-cell tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Params common to all runs</span>
<span class="n">wf</span><span class="p">[</span><span class="n">CoordTransformGraph</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span>
<span class="n">wf</span><span class="p">[</span><span class="n">MaskedRange</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="mf">0.26</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">),</span> <span class="n">sc</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="mf">0.27</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="n">wf</span><span class="p">[</span><span class="n">BinWidth</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;meV&quot;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
    <span class="n">wf</span><span class="p">[</span><span class="n">Foldername</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
    <span class="n">results</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">EnergyTransferHistogram</span><span class="p">)</span>

<span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f75b014acfe99f4004de3bee0cfde3aaa6738aece2eba95bd1d40bb6544d602f.svg" src="../_images/f75b014acfe99f4004de3bee0cfde3aaa6738aece2eba95bd1d40bb6544d602f.svg" />
</div>
</details>
</div>
</section>
<section id="exercise-5-make-a-y-delta-e-map">
<h3>Exercise 5: Make a <span class="math notranslate nohighlight">\((y, \Delta E)\)</span> map<a class="headerlink" href="#exercise-5-make-a-y-delta-e-map" title="Link to this heading">#</a></h3>
<p>We wish to make a 2d plot of counts as a function of <span class="math notranslate nohighlight">\(y\)</span> and energy transfer for one of runs (e.g. elastic).
You have to:</p>
<ul class="simple">
<li><p>identify one of the intermediate results that would contain the necessary information</p></li>
<li><p>compute that intermediate result</p></li>
<li><p>histogram the result (200 bins in <code class="docutils literal notranslate"><span class="pre">y</span></code> and 200 bins in <code class="docutils literal notranslate"><span class="pre">energy_transfer</span></code> will do nicely)</p></li>
<li><p>plot it on a figure</p></li>
</ul>
<p><strong>Hint:</strong> The solution is very simple, and should only be 2-3 lines of python at most!</p>
<p><strong>Solution:</strong></p>
<div class="cell tag_hide-cell tag_solution docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wf</span><span class="p">[</span><span class="n">Foldername</span><span class="p">]</span> <span class="o">=</span> <span class="n">folders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">da</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">EnergyTransferData</span><span class="p">)</span>
<span class="n">da</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">energy_transfer</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/dbd028e9983e868beb59f3b8061ec7221c3e12f4c08a68dccdb84a8ba7179644.svg" src="../_images/dbd028e9983e868beb59f3b8061ec7221c3e12f4c08a68dccdb84a8ba7179644.svg" />
</div>
</details>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./4-reduction"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="reduction-powder-diffraction.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Powder diffraction data reduction</p>
      </div>
    </a>
    <a class="right-next"
       href="reduction-sans.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">SANS data reduction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-the-elastic-sample-data">Process the elastic sample data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-raw-data">Load raw data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-raw-data">Visualize the raw data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-mask-bad-region">Exercise 1: mask bad region</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transform-to-energy-transfer">Transform to energy transfer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-compute-energy-transfer">Exercise 2: Compute energy transfer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-1-finish-the-graph">Exercise 2.1: Finish the graph</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-2-compute-energy-transfer-with-the-masked-data">Exercise 2.2: Compute energy transfer with the masked data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-3-compute-energy-transfer-for-unmasked-data">Exercise 2.3: Compute energy transfer for unmasked data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-compute-energy-transfer-for-all-samples">Exercise 3: Compute energy transfer for all samples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-result-to-disk">Save result to disk</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise">Bonus exercise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sciline-workflow">Sciline workflow</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-set-the-workflow-parameters">Exercise 4: Set the workflow parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-make-a-y-delta-e-map">Exercise 5: Make a <span class="math notranslate nohighlight">\((y, \Delta E)\)</span> map</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Data Management and Scientific Computing centre
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>